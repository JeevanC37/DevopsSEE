---
- name: Docker Build and Push for Banking App
  hosts: localhost  # Changed 'local' to 'localhost' to match Jenkins environment
  gather_facts: yes

  tasks:  
    # --- FRONTEND SECTION ---
    - name: Build Docker Image (Frontend)
      command: docker build -t banking-app .
      args:
        chdir: /var/lib/jenkins/workspace/DevopsSEE

    - name: Tag image (Frontend)
      command: docker tag banking-app:latest jeevanc370/banking-app:latest 

    # --- BACKEND SECTION (NEW) ---
    - name: Build Docker Image (Backend)
      # Uses the 'backend' folder where we created the Dockerfile
      command: docker build -t banking-backend backend
      args:
        chdir: /var/lib/jenkins/workspace/DevopsSEE

    - name: Tag image (Backend)
      command: docker tag banking-backend:latest jeevanc370/banking-backend:latest

    # --- SHARED LOGIN ---
    - name: Log in to Docker Hub
      community.docker.docker_login:
        registry_url: https://index.docker.io/v1/
        username: "jeevanc370" 
        password: "204976Ca!"

    # --- PUSH SECTION ---
    - name: Push image (Frontend)
      command: docker push jeevanc370/banking-app:latest

    - name: Push image (Backend)
      command: docker push jeevanc370/banking-backend:latest

    # --- TEST CONTAINER SECTION (Frontend Only) ---
    - name: Remove old test container
      command: docker rm -f bank-test
      ignore_errors: yes

    - name: Run container (Test)
      command: docker run -d --name bank-test -p 8081:80 jeevanc370/banking-app:latest
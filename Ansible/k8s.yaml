---
- name: Deploy Kubernetes Application
  hosts: k8s  # Matches your inventory file group for the K8s Master
  gather_facts: yes
  become: yes # Ensures we have permission to write files and run kubectl

  tasks:
    - name: Copy deployment.yaml to Kubernetes master
      copy:
        # Source is your Jenkins workspace where the new file is
        src: /var/lib/jenkins/workspace/DevopsSEE/deployment.yaml
        # Destination is the home directory of the user running kubectl
        dest: /home/ubuntu/deployment.yaml
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Apply Deployment (Rolling Update)
      # This uses kubectl apply which does a rolling update
      # Pods are only restarted if the image or spec changes
      # This preserves backend pod's in-memory Trivy data when nothing changed
      command: kubectl apply -f /home/ubuntu/deployment.yaml

    - name: Force rollout to pull new images
      # imagePullPolicy: Always only works when pods restart
      # This forces a restart to pull the latest images from Docker Hub
      shell: |
        kubectl rollout restart deployment banking-app
        kubectl rollout restart deployment backend-app
        kubectl rollout status deployment banking-app --timeout=120s
        kubectl rollout status deployment backend-app --timeout=120s